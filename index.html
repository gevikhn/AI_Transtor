<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Translator</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https:; style-src 'self' 'unsafe-inline'; script-src 'self';" />
  <meta name="theme-color" content="#0d0f11" />
  <script src="js/theme-init.js"></script>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="manifest" href="manifest.webmanifest" />
  
</head>
<body>
  <header class="bar">
    <h1 class="app-title">AI Translator <small id="buildInfo" style="font-weight:normal;font-size:0.6em;opacity:0.7"></small></h1>
    <div class="bar-tools">
      <button id="btnMdModeToggle" class="icon-btn" type="button" title="粘贴为纯文本" aria-label="粘贴为纯文本" aria-pressed="false"></button>
      <button id="btnThemeToggle" class="icon-btn" type="button" title="自动（跟随系统）" aria-label="自动（跟随系统）" aria-pressed="false"></button>
    </div>
  </header>
  <main class="layout">
    <section class="controls">
      <label><select id="serviceSelect"></select></label>
      <label><select id="langSelect" data-ref="lang"></select></label>
      <div class="btn-row">
        <button id="btnTranslate" class="btn primary">翻译 (Ctrl+Enter)</button>
        <button id="btnClear" class="btn">清空</button>
        <button id="btnCopy" class="btn">复制</button>
        <nav><button id="openSettings" class="btn">设置</button></nav>
      </div>
    </section>
    <section class="panes">
      <div class="pane">
      <textarea id="inputText" placeholder="在此粘贴或拖拽待翻译文本（含 .txt 文件）" spellcheck="false"></textarea>
      </div>
  <div class="pane">
  <div id="outputView" class="markdown-body" aria-live="polite" tabindex="0" data-role="output" data-copy-source></div>
  </div>
    </section>
    <section class="status" id="statusBar" aria-live="polite">就绪</section>
  </main>

  <!-- 设置模态 -->
  <div id="settingsOverlay" class="modal-overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <header class="modal-bar">
        <h2 id="settingsTitle">设置</h2>
        <div class="flex-gap"></div>
        <button id="closeSettings" class="btn">关闭 (Esc)</button>
      </header>
      <div class="modal-body settings-body">
        <form id="settingsForm">
          <fieldset>
            <legend>服务管理</legend>
            <div class="btn-row" style="gap:.5rem;align-items:flex-end;flex-wrap:wrap">
              <label>当前服务 <select id="svcSelect"></select></label>
              <label>名称 <input id="svcName" type="text" placeholder="服务名称"/></label>
              <button type="button" id="btnAddSvc" class="btn">新增配置</button>
              <button type="button" id="btnDelSvc" class="btn danger">删除配置</button>
              <button type="submit" class="btn primary">保存</button>
            </div>
          </fieldset>

          <fieldset>
            <legend>全局</legend>
            <label>主密码（可选） <input name="masterPassword" id="masterPassword" data-field="masterPassword" type="password" placeholder="留空则使用默认密钥" autocomplete="new-password" /></label>
            <label>默认目标语言 <select name="targetLanguage" data-field="targetLanguage"></select></label>
            <label>Prompt 模板</label>
            <textarea name="promptTemplate" data-field="promptTemplate" rows="10" placeholder="Prompt 模板"></textarea>
          </fieldset>

          <fieldset>
            <legend>服务</legend>
            <label>API 类型
              <select name="apiType" data-field="apiType">
                <option value="openai-responses">OpenAI Responses API</option>
                <option value="openai-chat">OpenAI Chat Completions</option>
                <option value="claude">Claude (Anthropic)</option>
              </select>
            </label>
            <label>Base URL <input name="baseUrl" data-field="baseUrl" placeholder="https://api.openai.com/v1" required /></label>
            <label>API Key <input name="apiKey" data-field="apiKey" type="password" placeholder="sk-..." autocomplete="off" /></label>
            <label>模型 <input name="model" data-field="model" placeholder="gpt-4o-mini / claude-3-5-sonnet" /></label>
          </fieldset>
        <fieldset><legend>高级</legend>
          <label>流式输出 <input type="checkbox" name="stream" data-field="stream"/></label>
          <label>Temperature <input type="number" step="0.1" min="0" max="2" name="temperature" data-field="temperature"/></label>
          <label>Max Tokens <input type="number" min="1" name="maxTokens" data-field="maxTokens"/></label>
          <label>超时(ms) <input type="number" min="1000" name="timeoutMs" data-field="timeoutMs" placeholder="30000"/></label>
          <label>重试次数 <input type="number" min="0" max="5" name="retries" data-field="retries" placeholder="2"/></label>
          <label>Store Responses <input type="checkbox" name="storeResponses" data-field="storeResponses"/></label>
          </fieldset>
        </form>

        <div class="settings-actions" aria-label="设置操作">
          <button id="toggleSettingsActions" class="btn icon-only" type="button" title="收起/展开" aria-label="收起/展开" aria-pressed="false" style="align-self:flex-end">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 9l4 4 4-4"/></svg>
            </span>
          </button>
          <div class="btn-row">
            <button type="button" id="btnTest" class="btn" title="连通性测试"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6M12 16v6M4 12h6M14 12h6"/></svg></span><span class="label">连通性测试</span></button>
            <button type="button" id="btnExport" class="btn" title="导出(包含密钥)"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v8M8 9l4-4 4 4"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/></svg></span><span class="label">导出(包含密钥)</span></button>
            <button type="button" id="btnExportSafe" class="btn" title="导出(移除密钥)"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v8M8 9l4-4 4 4"/><path d="M3 15h18"/></svg></span><span class="label">导出(移除密钥)</span></button>
            <button type="button" id="btnImport" class="btn" title="导入"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V11M16 15l-4 4-4-4"/><path d="M21 9V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v4"/></svg></span><span class="label">导入</span></button>
            <button type="button" id="btnImportUrl" class="btn" title="URL导入"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"/><path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"/></svg></span><span class="label">URL导入</span></button>
            <button type="button" id="btnNewSession" class="btn" title="新建会话"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg></span><span class="label">新建会话</span></button>
            <button type="button" id="btnDeleteSession" class="btn danger" title="删除会话"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></span><span class="label">删除会话</span></button>
          </div>
          <input type="file" id="importFile" accept="application/json" hidden />
          <section id="settingsStatus" class="status" aria-live="polite">未修改</section>
        </div>
      </div>
    </div>
  </div>

  
  <!-- 导入 URL 模态 -->
  <div id="importUrlOverlay" class="modal-overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="importUrlTitle">
      <header class="modal-bar">
        <h2 id="importUrlTitle">URL 导入</h2>
        <div class="flex-gap"></div>
        <button id="closeImportUrl" class="btn">关闭 (Esc)</button>
      </header>
      <div class="modal-body">
        <form id="importUrlForm">
          <label>配置 URL
            <input id="importUrlInput" type="url" placeholder="https://example.com/ai_tr_config.json" required />
          </label>
          <div class="btn-row" style="margin-top:8px">
            <button type="button" id="cancelImportUrl" class="btn">取消</button>
            <button type="submit" class="btn primary">导入</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 主密码验证模态 -->
  <div id="mpPromptOverlay" class="modal-overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mpPromptTitle">
      <header class="modal-bar">
        <h2 id="mpPromptTitle">主密码验证</h2>
        <div class="flex-gap"></div>
        <button id="closeMpPrompt" class="btn">关闭 (Esc)</button>
      </header>
      <div class="modal-body">
        <form id="mpPromptForm">
          <label>请输入导入配置的主密码以验证解锁
            <input id="mpPromptInput" type="password" placeholder="主密码" autocomplete="new-password" required />
          </label>
          <div class="btn-row" style="margin-top:8px">
            <button type="button" id="cancelMpPrompt" class="btn">取消</button>
            <button type="submit" class="btn primary">确定</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module" src="js/theme.js"></script>
  <script type="module" src="js/ui-translate.js"></script>
  <script type="module" src="js/ui-settings-modal.js"></script>
  <script type="module" src="js/pwa.js"></script>
</body>
</html>
